{% extends "layers/layer_base.html" %}

{% load i18n %}
{% load bootstrap_tags %}

{% block title %}{{ layer.typename }} â€” {{ block.super }}{% endblock %}

{% block body_class %}data{% endblock %}

{% block body_outer %}
<div class="page-header">
  <a href="{% url "layer_browse" %}" class="btn btn-primary pull-right">{% trans "Explore Layers" %}</a>
  <h2 class="page-title">{% trans "Edit Metadata" %}</h2>
</div>
<div class="row">
  <div class="col-md-8">
    <p class="lead">
      {% blocktrans with layer.typename as layer_title %}
        Editing details for {{ layer_title }}
      {% endblocktrans %}
    </p>

    <form class="form-horizontal" action="{% url "layer_metadata" layer.service_typename %}" method="POST">
      {% if layer.metadata_uploaded %}
    	<p class="bg-warning">{% blocktrans %}Note: this layer's orginal metadata was populated by importing a metadata XML file.
          GeoNode's metadata import supports a subset of ISO, FGDC, and Dublin Core metadata elements.
          Some of your original metadata may have been lost.{% endblocktrans %}</p>
      {% endif %}

      {% if layer_form.errors or attribute_form.errors or category_form.errors or author_form.errors or poc.errors %}
    	  <p class="bg-danger">{% blocktrans %}Error updating metadata.  Please check the following fields: {% endblocktrans %}</p>
          <ul class="bg-danger">
          {% if author_form.errors %}
            <li>{% trans "Metadata Author" %}</li>
            {{ author_form.errors }}
          {% endif %}
          {% if poc_form.errors %}
            <li>{% trans "Point of Contact" %}</li>
            {{ poc_form.errors }}
          {% endif %}
          {% for field in layer_form %}
            {% if field.errors %}
            <li>{{ field.label }}</li>
            {% endif %}
          {% endfor %}
          {% if not attribute_form.is_valid %}
            <li>{% trans "Attributes" %}</li>
            {% for field in attribute_form %}
            {% if field.errors %}
            <li>{{ field.errors }}</li>
            {% endif %}
            {% endfor %}
          {% endif %}
          {% if category_form.errors %}
            <li>{{ category_form.errors.as_ul }}</li>
          {% endif %}
          </ul>
        {% endif %}
        <div class="form-actions">
          <input type="submit" class="btn btn-primary" value="{% trans "Update" %}"/>
        </div>


        {% csrf_token %}
        <div class="col-md-6 form-controls">
          {{ layer_form | as_bootstrap }}
        </div>

        <div class="row">
          <div class="col-md-12">
            <label class="control-label required-field">{% trans "Category" %}</label>
            <fieldset id="category_form">
              {% autoescape off %}
              {% for choice in category_form.category_choice_field.field.choices %}
              <div class="radio col-md-6">
                <input type="radio" name="category_choice_field" value="{{ choice.0 }}"
                  {% ifequal category_form.initial choice.0 %} checked="checked" {% endifequal %}>
                  {{ choice.1 }}
                </input>
              </div>
              {% endfor %}
              {% endautoescape %}
            </fieldset>
          </div>
          <div class="col-md-12 grid-spacer">
            <h5>{% trans "Attributes" %}</h5>
            {{ attribute_form.management_form }}
            <button type="button" class="btn btn-primary" id="label_auto_complete">Auto Complete Labels</button>
            <button type="button" class="btn btn-primary" id="descr_auto_complete">Auto Complete Descriptions</button>
            </br></br>
            <table class="table table-striped table-bordered table-condensed" id="attributes_tbl">
              <tr>
                <th>{% trans "Attribute" %}</th>
                <th>{% trans "Label" %}</th>
                <th>{% trans "Description" %}</th>
                <th>{% trans "Display Order" %}</th>
              </tr>
              {% for form in attribute_form.forms %}
              {% if form.attribute %}
              <tr>
                <td><div class="default_attr_name" style="display:none">{{form.id}}</div>{{form.attribute}}</td>
                <td>{{form.attribute_label}}</td>
                <td>{{form.description}}</td>
                <td>{{form.display_order}}</td>
              </tr>
              {% endif %}
              {% endfor %}
            </table>

            <fieldset class="form-controls modal-forms modal hide fade" id="poc_form" >
              <h2>{% trans "Point of Contact" %}</h2>
              {{ poc_form|as_bootstrap }}
              <button type='button' class="modal-cloose-btn btn btn-primary">Done</button>
            </fieldset>
            <fieldset class="form-controls modal-forms modal hide fade" id="metadata_form">
              <h2>{% trans "Metadata Provider" %}</h2>
                {{ author_form|as_bootstrap }}
              <button type='button' class="modal-cloose-btn btn btn-primary">Done</button>
            </fieldset>

            <div class="form-actions">
              <input type="submit" class="btn btn-primary" value="{% trans "Update" %}"/>
            </div>
          </div>
        </div>
      </form>
  </div>
</div>
{% endblock %}
{% block extra_script %}
  <script type="text/javascript">
  $(document.body).on("click", "#id_resource-keywords",function(e){
    if ($('#key_comment').length == 0) {
      $( "<div class='alert alert-warning' id='key_comment'>The keyword has to describe the layer but it is not necessary to include information mentioned in the Title or the Regions sections. E.g. Do not include country names as keywords.</div>" ).insertBefore( "#id_resource-keywords" );
    }
  });
  // auto complete for decsriptions of attributes based on enumerations file
  $(document.body).on("click", "#descr_auto_complete",function(e){
    attribute_descriptions = {{attribute_descriptions | safe }};
    $("#attributes_tbl tr").each(function(){
        var value = $(this).find("td input:nth-child(2)").val();
        //for (var i = 0; i < attr_names.length; i++) {
          if (value in attribute_descriptions){
            description = attribute_descriptions[value]
            $(this).find('td:nth-child(3) input').val(description);
          }
    });
  });
  // auto complete for labels of attributes based on enumerations file
  $(document.body).on("click", "#label_auto_complete",function(e){
    attribute_label = {{attribute_label | safe }};
    $("#attributes_tbl tr").each(function(){
        var value = $(this).find("td input:nth-child(2)").val();
          if (value in attribute_label){
            description = attribute_label[value]
            $(this).find('td:nth-child(2) input').val(description);
          }
    });
  });

  $(function() {
    $( '<div id="vmap" style="width: 375px; height: 275px;  margin-left: -15px;"></div></br>' ).insertBefore( $( "#div_id_resource-regions" ) );

    $( '</br></br> <div class="panel-group" id="additional_metadata" style="width: 375px;"> <div class="panel panel-default"> <div class="panel-heading"> <h4 class="panel-title"> <a data-toggle="collapse" href="#collapse1">Advanced Metadata</a> </h4> </h4> </div> <div id="collapse1" class="panel-collapse collapse"> <div id="panel_body" class="panel-body"></div> </div>  </div> </div></br>' ).insertAfter( $( "#id_resource-metadata_author-wrapper" ) );

    $("#div_id_resource-date_type, #div_id_resource-edition, #div_id_resource-purpose, #div_id_resource-maintenance_frequency, #div_id_resource-restriction_code_type, #div_id_resource-constraints_other, #div_id_resource-license, #div_id_resource-language, #div_id_resource-spatial_representation_type, #div_id_resource-temporal_extent_start, #div_id_resource-temporal_extent_end,  #div_id_resource-supplemental_information,  #div_id_resource-distribution_url, #div_id_resource-distribution_description, #div_id_resource-data_quality_statement, #div_id_resource-featured, #div_id_resource-is_published, #div_id_resource-thumbnail_url" ).detach().appendTo('#panel_body')

    $('#vmap').vectorMap(
    {
      map: 'world_en',
      backgroundColor: '#a5bfdd',
      borderColor: '#818181',
      borderOpacity: 0.25,
      borderWidth: 1,
      color: '#f4f3f0',
      enableZoom: true,
      hoverColor: '#c9dfaf',
      hoverOpacity: null,
      normalizeFunction: 'linear',
      scaleColors: ['#b6d6ff', '#005ace'],
      selectedColor: '#c9dfaf',
      selectedRegions: null,
      showTooltip: true,
      onRegionClick: function(element, code, region)
      {

        if ($('#regions_comment').length !== 0) {
          $("#regions_comment").remove();
        }
          var message = 'You clicked "'
              + region
              + '" which has the code: '
              + code.toUpperCase();

          // select country from the map and get the corresponding country on the menu
          $("#id_resource-regions").val(code)
          var indx = $("select#id_resource-regions").find(":selected").index();
           $('#id_resource-regions').animate({
              scrollTop: indx * 16
           }, 500);

          if ($('#regions_comment').length == 0) {
            if(!isNaN(code)){
              $( "<div class='alert alert-success' style='width: 375px; margin-left: -15px;' id='regions_comment'>Selected region " + region + "</div>" ).insertAfter( "#vmap" );
            } else {
              $( "<div class='alert alert-warning' style='width: 375px; margin-left: -15px;' id='regions_comment'>Selected region " + region + " was not found. Please use the list below to find it.</div>" ).insertAfter( "#vmap" );
            }
          }
      }
    });
    });
  </script>
 {% include 'metadata_form_js.html' %}
{% endblock extra_script %}
